<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>NeerNetra - Report</title>
    <link rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
    * { margin:0; padding:0; box-sizing:border-box; font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }

    body {
      background-color:#f0f8ff; color:#0a3d62;
      max-width:480px; margin:0 auto; min-height:100vh;
      box-shadow:0 0 15px rgba(0,0,0,0.1);
    }
    .container { padding:20px; }
    .header { display:flex; justify-content:space-between; align-items:center; padding:15px 0;
      border-bottom:2px solid #0a3d62; margin-bottom:20px; }
    .logo { font-size:24px; font-weight:bold; }
    .back-arrow { font-size:22px; cursor:pointer; }

    .input-group { margin-bottom:20px; }
    .input-group label { display:block; margin-bottom:6px; font-weight:500; }
    .input-group input, .input-group textarea {
      width:100%; padding:12px; border:1px solid #0a3d62; border-radius:8px;
      background:#f9f9f9; font-size:15px;
    }
    .input-group textarea { resize:vertical; min-height:100px; }

    fieldset {
      border:1px solid #0a3d62; border-radius:8px; padding:10px; margin-bottom:20px;
    }
    fieldset legend { font-weight:bold; }
    fieldset label { display:block; margin:5px 0; }

    video {
      width:100%; border:1px solid #ccc; border-radius:8px;
      background:black; margin:15px 0;
    }

    .btn {
      background:#3498db; color:white; border:none; padding:14px 20px;
      border-radius:8px; cursor:pointer; font-size:16px; width:100%;
      transition:background 0.3s;
    }
    .btn:hover { background:#2980b9; }
    .btn:disabled { background:#ccc; cursor:not-allowed; }

    #log {
      background:#f8f8f8; padding:10px; font-size:13px; white-space:pre-wrap;
      border-radius:8px; margin-top:20px; min-height:60px;
    }

    @media(max-width:480px){
      body{ max-width:100%; }
      .container{ padding:15px; }
    }
    .hazard-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    gap: 8px 16px; /* row gap, column gap */
    }

    .hazard-grid label {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 14px;
    cursor: pointer;
    }
  .popup {
    display: none; /* hidden by default */
    position: fixed;
    z-index: 9999;
    left: 0; top: 0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.5);
  }

  .popup-content {
    background: #fff;
    color: #0a3d62;
    margin: 15% auto;
    padding: 20px;
    border-radius: 10px;
    max-width: 400px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.3);
  }

  .popup-close {
    float: right;
    font-size: 22px;
    cursor: pointer;
  }

  .popup h3 {
    margin-bottom: 10px;
  }

  .popup pre {
    white-space: pre-wrap;
    font-size: 14px;
    color: #333;
}
  </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <div class="back-arrow"><i class="fas fa-arrow-left"></i></div>
        <div class="logo">Hazard Report</div>
        <div style="width:24px;"></div>
      </div>

      <form id="reportForm">
        <div class="input-group">
          <label for="user_text">Hazard Description</label>
          <input type="text" id="user_text"
            placeholder="Describe the hazard...">
          <small id="descRequired"
            style="color:red; font-size:12px; display:none;">REQUIRED</small>

        </div>

        <fieldset>
          <legend>Hazard Type</legend>
          <div class="hazard-grid">
            <label><input type="radio" name="user_submit_type"
                value="0"> UNKNOWN</label>
            <label><input type="radio" name="user_submit_type"
                value="1" checked> TIDE</label>
            <label><input type="radio" name="user_submit_type"
                value="2"> COASTAL_DAMAGE</label>
            <label><input type="radio" name="user_submit_type"
                value="3"> FLOODING</label>
            <label><input type="radio" name="user_submit_type"
                value="4"> WAVES</label>
            <label><input type="radio" name="user_submit_type"
                value="5"> SWELL</label>
            <label><input type="radio" name="user_submit_type"
                value="6"> SURGE</label>
            <label><input type="radio" name="user_submit_type"
                value="7"> STORM</label>
            <label><input type="radio" name="user_submit_type"
                value="8"> TSUNAMI</label>
            <label><input type="radio" name="user_submit_type"
                value="9"> OTHER</label>
          </div>
        </fieldset>

        <video id="preview" autoplay muted playsinline></video>
        <button type="button" class="btn" id="startBtn">Record 10s &
          Submit</button>
      </form>

      <h3>Status</h3>
      <!-- Popup -->
      <div id="popup" class="popup">
        <div class="popup-content">
          <span id="popupClose" class="popup-close">&times;</span>
          <h3 id="popupTitle">Message</h3>
          <pre id="popupMessage"></pre>
        </div>
      </div>
      <!-- Login Required Popup -->
      <div id="loginPopup" class="popup">
        <div class="popup-content">
          <h3>You are not logged in</h3>
          <div
            style="margin-top:15px; display:flex; gap:10px; justify-content:flex-end;">
            <button id="guestBtn" class="btn" style="background:#7f8c8d;">Guest
              Report</button>
            <button id="loginBtn" class="btn">Login</button>
          </div>
        </div>
      </div>

      <!-- Location Required Popup -->
      <div id="locationPopup" class="popup">
        <div class="popup-content">
          <h3>Location Required</h3>
          <p style="margin:10px 0;">
            This report requires your location.<br>
            Please allow GPS access.<br><br>
            If you have previously denied, go to your browser or device
            settings and enable Location access for this site.
          </p>
          <div
            style="margin-top:15px; display:flex; gap:10px; justify-content:flex-end;">
            <button id="locationCancel" class="btn"
              style="background:#7f8c8d;">Cancel</button>
            <button id="locationAllow" class="btn">Allow</button>
          </div>
        </div>
      </div>

      <!-- Camera Required Popup (NEW) -->
      <div id="cameraPopup" class="popup">
        <div class="popup-content">
          <h3>Camera Required</h3>
          <p style="margin:10px 0;">
            This report requires camera access.<br>
            Please allow camera permission.<br><br>
            If you have previously denied, go to your browser or device
            settings and enable Camera access for this site.
          </p>
          <div
            style="margin-top:15px; display:flex; gap:10px; justify-content:flex-end;">
            <button id="cameraRetry" class="btn">Retry</button>
          </div>
        </div>
      </div>

      <pre id="log">Idle</pre>
    </div>

    <script>
      async function checkLogin() {
        try {
          const resp = await fetch("/api/check-auth/", { credentials: "include" });
          if (!resp.ok) return false;
          const data = await resp.json();
          return data.is_authenticated === true;
        } catch {
          return false;
        }
      }

      function showPopup(title, message) {
        document.getElementById("popupTitle").textContent = title;
        document.getElementById("popupMessage").textContent = message;
        document.getElementById("popup").style.display = "block";
      }

      function closePopup() {
        document.getElementById("popup").style.display = "none";
      }

      document.getElementById("popupClose").onclick = closePopup;
      window.onclick = function(e) {
        if (e.target === document.getElementById("popup")) closePopup();
      };

      // Location popup function
      function getLocationWithPopup() {
        return new Promise((resolve) => {
          const popup = document.getElementById("locationPopup");
          popup.style.display = "block";

          document.getElementById("locationAllow").onclick = () => {
            popup.style.display = "none";

            if (!navigator.geolocation) {
              showPopup("Error", "Geolocation not supported by this browser.");
              return resolve(null);
            }

            navigator.geolocation.getCurrentPosition(
              pos => resolve({
                lat: pos.coords.latitude,
                lon: pos.coords.longitude,
                alt: pos.coords.altitude,
                acc: pos.coords.accuracy,
                speed: pos.coords.speed,
                heading: pos.coords.heading,
                ts: new Date(pos.timestamp).toISOString()
              }),
              err => {
                // keep asking until allowed
                popup.style.display = "block";
                resolve(null);
              },
              { enableHighAccuracy: true, timeout: 5000 }
            );
          };

          document.getElementById("locationCancel").onclick = () => {
            popup.style.display = "block"; // reopen, can't continue
            resolve(null);
          };
        });
      }

      // Camera popup function
      async function getCameraWithPopup() {
        const popup = document.getElementById("cameraPopup");
        popup.style.display = "block";

        return new Promise((resolve) => {
          async function tryCamera() {
            try {
              let stream;
              try {
                stream = await navigator.mediaDevices.getUserMedia({
                  video: { facingMode: { exact: "environment" } },
                  audio: true
                });
              } catch (err) {
                stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
              }
              popup.style.display = "none";
              resolve(stream);
            } catch (err) {
              popup.style.display = "block"; // keep showing until allowed
            }
          }
          document.getElementById("cameraRetry").onclick = tryCamera;
          tryCamera();
        });
      }

function showLoginPopup(onGuestContinue) {
  const popup = document.getElementById("loginPopup");
  popup.style.display = "block";

  document.getElementById("guestBtn").onclick = () => {
    popup.style.display = "none";
    if (onGuestContinue) onGuestContinue();
  };

  document.getElementById("loginBtn").onclick = () => {
    window.location.href = "/login";
  };

  window.onclick = function(e) {
    if (e.target === popup) popup.style.display = "none";
  };
}

document.addEventListener("DOMContentLoaded", async () => {
  const isLoggedIn = await checkLogin();
  if (!isLoggedIn) {
    showLoginPopup(() => {
      console.log("Continuing as guest...");
    });
  }
});

(async () => {
  const logEl=document.getElementById("log");
  const startBtn=document.getElementById("startBtn");
  const preview=document.getElementById("preview");
  const descInput = document.getElementById("user_text");
  const descRequired = document.getElementById("descRequired");
    if (descInput.value.trim()) {
      descRequired.style.display = "none";
    }
  descInput.addEventListener("input", () => {
    if (descInput.value.trim()) {
      descRequired.style.display = "none";
    }
  });

  function log(...a){ logEl.textContent+="\n"+a.join(" "); console.log(...a); }
  function warn(msg) { log("⚠️ " + msg); console.warn("⚠️ " + msg); }

  let accelData=[],gyroData=[],oriData=[],magData=[],baroData=[],startTime=null;
  function relT(){ return (performance.now()-startTime)/1000; }

  function handleMotion(e){
    if(!startTime) return;
    const t=relT();
    const a=e.accelerationIncludingGravity||{x:0,y:0,z:0};
    accelData.push([a.x||0,a.y||0,a.z||0,t]);
    if(e.rotationRate){
      gyroData.push([e.rotationRate.alpha||0,e.rotationRate.beta||0,e.rotationRate.gamma||0,t]);
    }
  }
  function handleOrientation(e){
    if(!startTime) return;
    oriData.push([e.gamma||0,e.beta||0,e.alpha||0,relT()]);
  }

  let magnetometer,barometer;
  function startMag(){
    try {
      if("Magnetometer" in window){
        magnetometer=new Magnetometer({frequency:60});
        magnetometer.addEventListener("reading",()=>{ magData.push([magnetometer.x||0,magnetometer.y||0,magnetometer.z||0,relT()]); });
        magnetometer.start();
      } else {
        warn("Magnetometer not supported by this device/browser");
      }
    } catch(e) { warn("Magnetometer init failed: " + e.message); }
  }
  function startBaro(){
    try {
      if("Barometer" in window){
        barometer=new Barometer({frequency:1});
        barometer.addEventListener("reading",()=>{ baroData.push([barometer.pressure||0,relT()]); });
        barometer.start();
      } else {
        warn("Barometer not supported by this device/browser");
      }
    } catch(e) { warn("Barometer init failed: " + e.message); }
  }

  function downsample(series, targetHz=10){
    if(!series.length) return [];
    const duration=series[series.length-1][series[0].length-1];
    const step=1/targetHz, out=[];
    for(let t=0;t<=duration;t+=step){
      let closest=series.reduce((a,b)=>Math.abs(b[b.length-1]-t)<Math.abs(a[a.length-1]-t)?b:a);
      out.push(closest);
    }
    return out;
  }

  async function recordAndSend(){
    startBtn.disabled=true;
    logEl.textContent=""; log("Starting record...");

    // 📝 Require Hazard Description
    const desc = document.getElementById("user_text").value.trim();
    if (!desc) {
      descRequired.style.display = "block";
      showPopup("Error", "Hazard Description is required.");
      startBtn.disabled=false;
      return;
    }

    // 📍 Require location
    let geo=null;
    while (!geo) {
      geo = await getLocationWithPopup();
    }

    // 📷 Require camera
    let stream=null;
    while (!stream) {
      stream = await getCameraWithPopup();
    }

    preview.srcObject=stream;
    const rec=new MediaRecorder(stream,{mimeType:"video/webm;codecs=vp8,opus"});
    const chunks=[];
    rec.ondataavailable=e=>{if(e.data.size)chunks.push(e.data);};

    startTime=performance.now();
    rec.start();
    await new Promise(r=>setTimeout(r,10000));
    rec.stop();
    await new Promise(r=>rec.onstop=r);

    const blob=new Blob(chunks,{type:"video/webm"});
    const file=new File([blob],"hazard.webm",{type:"video/webm"});
    stream.getTracks().forEach(t=>t.stop());

    const client_info={ userAgent:navigator.userAgent, platform:navigator.platform, language:navigator.language };
    const track=stream.getVideoTracks()[0];
    const settings=track.getSettings();
    if (!settings.frameRate) warn("Frame rate not available");
    if (!preview.videoWidth || !preview.videoHeight) warn("Resolution not available");

    if (!oriData.length) warn("No orientation data captured");

    const lastOri=oriData.length?oriData.at(-1):[null,null,null];
    const geovideo = {
      device_model: "",
      software_info: "",
      location: geo ? `POINT(${geo.lon} ${geo.lat})` : null,
      altitude: geo ? geo.alt : null,
      gps_accuracy: geo ? geo.acc : null,
      speed: geo ? geo.speed : null,
      direction: geo ? geo.heading : null,
      gps_fix_type: null,
      num_satellites: null,
      timestamp_utc: geo ? geo.ts : new Date().toISOString(),
      orientation_roll: lastOri[0],
      orientation_pitch: lastOri[1],
      orientation_yaw: lastOri[2],
      resolution: (preview.videoWidth && preview.videoHeight) ? `${preview.videoWidth}x${preview.videoHeight}` : null,
      frame_rate: settings.frameRate ?? null,
      aperture: null,
      iso: null,
      lens: null,
      accelerometer: downsample(accelData, 10),
      gyroscope: downsample(gyroData, 10),
      magnetometer: downsample(magData, 10),
      barometer: downsample(baroData, 1),
      orientation_series: downsample(oriData, 10),
      duration_sec: 10
    };

    const fd=new FormData();
    fd.append("user_text",desc);
    fd.append("user_submit_type",document.querySelector("input[name=user_submit_type]:checked").value);
    fd.append("user_video",file);
    fd.append("geovideo",JSON.stringify(geovideo));
    fd.append("client_info",JSON.stringify(client_info));

    log("Sending report...");
    try {
      const resp = await fetch("/api/user-reports/", { method: "POST", body: fd });
      const text = await resp.text();
      log("Response:", resp.status, text);

      if (resp.ok) {
        window.location.href = "/report_submit";
      } else {
        showPopup("Unexpected response: " + resp.status, text);
      }
    } catch (e) {
      log("Upload error:", e);
      showPopup("Network error", e.message);
    }
    startBtn.disabled=false;
  }

  startBtn.onclick=()=>recordAndSend();
})();
</script>
  </body>
</html>
